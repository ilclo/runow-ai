@file:OptIn(androidx.compose.material3.ExperimentalMaterial3Api::class)packageai.runow.ui.rendererimportandroidx.compose.animation.core.animateFloatAsStateimportandroidx.compose.foundation.BorderStrokeimportandroidx.compose.foundation.clickableimportandroidx.compose.foundation.horizontalScrollimportandroidx.compose.foundation.interaction.MutableInteractionSourceimportandroidx.compose.foundation.interaction.collectIsPressedAsStateimportandroidx.compose.foundation.layout.*importandroidx.compose.foundation.layout.BoxScopeimportandroidx.compose.foundation.rememberScrollStateimportandroidx.compose.foundation.shape.CutCornerShapeimportandroidx.compose.foundation.shape.RoundedCornerShapeimportandroidx.compose.foundation.verticalScrollimportandroidx.compose.material.icons.Iconsimportandroidx.compose.material.icons.filled.*importandroidx.compose.material3.*importandroidx.compose.runtime.*importandroidx.compose.runtime.Composableimportandroidx.compose.ui.Alignmentimportandroidx.compose.ui.Modifierimportandroidx.compose.ui.graphics.Colorimportandroidx.compose.ui.graphics.graphicsLayerimportandroidx.compose.ui.draw.shadowimportandroidx.compose.ui.layout.onGloballyPositionedimportandroidx.compose.ui.platform.LocalContextimportandroidx.compose.ui.platform.LocalDensityimportandroidx.compose.ui.text.TextStyleimportandroidx.compose.ui.text.style.TextAlignimportandroidx.compose.ui.text.style.TextOverflowimportandroidx.compose.ui.res.painterResourceimportandroidx.compose.foundation.backgroundimportandroidx.compose.ui.text.font.FontFamilyimportandroidx.compose.ui.text.font.FontWeightimportandroidx.compose.ui.unit.spimportandroidx.compose.ui.unit.Dpimportandroidx.compose.ui.unit.dpimportorg.json.JSONArrayimportorg.json.JSONObjectimportkotlin.math.maximportkotlin.math.minimportkotlin.math.round/*=========================*ENTRYPOINT*=========================*/@ComposablefunUiScreen(screenName:String,dispatch:(String)->Unit,uiState:MutableMap<String,Any>,designerMode:Boolean=false,scaffoldPadding:PaddingValues=PaddingValues(0.dp)){valctx=LocalContext.currentvarlayoutbyremember(screenName){mutableStateOf(UiLoader.loadLayout(ctx,screenName))}vartickbyremember{mutableStateOf(0)}if(layout==null){Box(Modifier.fillMaxSize(),contentAlignment=Alignment.Center){Text("Layout'$screenName'nontrovato",style=MaterialTheme.typography.bodyLarge)}return}//Ricomponeanchealvariareditick(usatoperanteprimalive)valmenusbyremember(layout,tick){mutableStateOf(collectMenus(layout!!))}varselectedPathbyremember(screenName){mutableStateOf<String?>(null)}varoverlayHeightPxbyremember{mutableStateOf(0)}valoverlayHeightDp=with(LocalDensity.current){(overlayHeightPx/density).dp}Box(Modifier.fillMaxSize()){Column(Modifier.fillMaxSize().padding(scaffoldPadding).verticalScroll(rememberScrollState()).padding(start=16.dp,end=16.dp,top=16.dp,bottom=if(designerMode)overlayHeightDp+32.dpelse16.dp),verticalArrangement=Arrangement.spacedBy(12.dp)){valblocks=layout!!.optJSONArray("blocks")?:JSONArray()for(iin0untilblocks.length()){valblock=blocks.optJSONObject(i)?:continuevalpath="/blocks/$i"RenderBlock(block=block,dispatch=dispatch,uiState=uiState,designerMode=designerMode,path=path,menus=menus,onSelect={p->selectedPath=p})}}if(designerMode){DesignerOverlay(screenName=screenName,layout=layout!!,selectedPath=selectedPath,setSelectedPath={selectedPath=it},//Anteprimalive:bumpdi'tick'onLiveChange={tick++},//Persistenzadraft/pubblica/reset:bumpe/oricaricoonLayoutChange={UiLoader.saveDraft(ctx,screenName,layout!!)layout=JSONObject(layout.toString())tick++},onSaveDraft={UiLoader.saveDraft(ctx,screenName,layout!!)},onPublish={UiLoader.saveDraft(ctx,screenName,layout!!);UiLoader.publish(ctx,screenName)},onReset={UiLoader.resetPublished(ctx,screenName)layout=UiLoader.loadLayout(ctx,screenName)selectedPath=nulltick++},onOverlayHeight={overlayHeightPx=it})}}}/*=========================*RENDERER*=========================*/@ComposableprivatefunRenderBlock(block:JSONObject,dispatch:(String)->Unit,uiState:MutableMap<String,Any>,designerMode:Boolean,path:String,menus:Map<String,JSONArray>,onSelect:(String)->Unit){valborderSelected=BorderStroke(1.dp,MaterialTheme.colorScheme.primary)//wrapperconoverlayselezione(inDesignerModecatturailtapsututtal'area)@ComposablefunWrapper(content:@Composable()->Unit){if(designerMode){Box{OutlinedCard(modifier=Modifier.fillMaxWidth().padding(0.dp),border=borderSelected,shape=RoundedCornerShape(12.dp)){Column(Modifier.padding(12.dp)){Text(block.optString("type",""),style=MaterialTheme.typography.labelSmall,color=MaterialTheme.colorScheme.primary)Spacer(Modifier.height(6.dp))content()}}//Overlay"trasparente"perselezionaresempreilbloccoBox(Modifier.matchParentSize().clickable(onClick={onSelect(path)}))}}else{Box{content()}}}when(block.optString("type")){"AppBar"->Wrapper{Text(block.optString("title",""),style=MaterialTheme.typography.titleLarge)valactions=block.optJSONArray("actions")?:JSONArray()if(actions.length()>0){Row(horizontalArrangement=Arrangement.spacedBy(8.dp)){for(iin0untilactions.length()){vala=actions.optJSONObject(i)?:continueFilledTonalButton(onClick={dispatch(a.optString("actionId"))}){Text(a.optString("icon","action"))}}}}}"IconButton"->Wrapper{valiconName=block.optString("icon","more_vert")valopenMenuId=block.optString("openMenuId","")valactionId=block.optString("actionId","")varexpandedbyremember{mutableStateOf(false)}Box{IconButton(onClick={if(openMenuId.isNotBlank()||actionId.startsWith("open_menu:")){expanded=true}elseif(actionId.isNotBlank()){dispatch(actionId)}}){NamedIconEx(iconName,null)}valmenuId=if(openMenuId.isNotBlank())openMenuIdelseactionId.removePrefix("open_menu:")valitems=menus[menuId]if(items!=null){DropdownMenu(expanded=expanded,onDismissRequest={expanded=false}){for(iin0untilitems.length()){valit=items.optJSONObject(i)?:continueDropdownMenuItem(text={Text(it.optString("label",""))},onClick={expanded=false;dispatch(it.optString("actionId",""))},leadingIcon={valic=it.optString("icon","")if(ic.isNotBlank())NamedIconEx(ic,null)})}}}}}"Card"->Wrapper{valvariant=block.optString("variant","elevated")valclickAction=block.optString("clickActionId","")valinner=@Composable{valinnerBlocks=block.optJSONArray("blocks")?:JSONArray()Column(verticalArrangement=Arrangement.spacedBy(8.dp)){for(iin0untilinnerBlocks.length()){valb=innerBlocks.optJSONObject(i)?:continuevalp2="$path/blocks/$i"RenderBlock(b,dispatch,uiState,designerMode,p2,menus,onSelect)}}}valmod=Modifier.fillMaxWidth().then(if(clickAction.isNotBlank()&&!designerMode)Modifier.clickable(onClick={dispatch(clickAction)})elseModifier)when(variant){"outlined"->OutlinedCard(mod){Column(Modifier.padding(12.dp)){inner()}}"filled"->Card(mod){Column(Modifier.padding(12.dp)){inner()}}else->ElevatedCard(mod){Column(Modifier.padding(12.dp)){inner()}}}}"Tabs"->Wrapper{valtabs=block.optJSONArray("tabs")?:JSONArray()varidxbyremember{mutableStateOf(0)}valcount=tabs.length().coerceAtLeast(1)if(idx>=count)idx=0vallabels=(0untilcount).map{tabs.optJSONObject(it)?.optString("label","Tab${it+1}")?:"Tab${it+1}"}TabRow(selectedTabIndex=idx){labels.forEachIndexed{i,label->Tab(selected=i==idx,onClick={idx=i},text={Text(label,maxLines=1,overflow=TextOverflow.Ellipsis)})}}Spacer(Modifier.height(8.dp))valtab=tabs.optJSONObject(idx)valblocks2=tab?.optJSONArray("blocks")?:JSONArray()Column(verticalArrangement=Arrangement.spacedBy(12.dp)){for(kin0untilblocks2.length()){valb=blocks2.optJSONObject(k)?:continuevalp2="$path/tabs/$idx/blocks/$k"RenderBlock(b,dispatch,uiState,designerMode,p2,menus,onSelect)}}}"SectionHeader"->Wrapper{valstyle=mapTextStyle(block.optString("style","titleMedium"))valalign=mapTextAlign(block.optString("align","start"))valspaceTop=block.optDouble("spaceTop",0.0).toFloat().dpvalspaceBottom=block.optDouble("spaceBottom",0.0).toFloat().dpvalpadStart=block.optDouble("padStart",0.0).toFloat().dpvalpadEnd=block.optDouble("padEnd",0.0).toFloat().dpvalclickAction=block.optString("clickActionId","")valtextColor=parseColorOrRole(block.optString("textColor",""))if(spaceTop>0.dp)Spacer(Modifier.height(spaceTop))Column(Modifier.fillMaxWidth().padding(start=padStart,end=padEnd).then(if(clickAction.isNotBlank()&&!designerMode)Modifier.clickable{dispatch(clickAction)}elseModifier)){Text(text=block.optString("title",""),style=applyTextStyleOverrides(block,style),modifier=Modifier.fillMaxWidth(),textAlign=align,color=textColor?:LocalContentColor.current)valsub=block.optString("subtitle","")if(sub.isNotBlank()){Text(sub,style=applyTextStyleOverrides(block,MaterialTheme.typography.bodyMedium),textAlign=align,modifier=Modifier.fillMaxWidth(),color=textColor?:LocalContentColor.current)}}if(spaceBottom>0.dp)Spacer(Modifier.height(spaceBottom))}"MetricsGrid"->Wrapper{valtiles=block.optJSONArray("tiles")?:JSONArray()valcols=block.optInt("columns",2).coerceIn(1,3)GridSection(tiles,cols,uiState)}"ButtonRow"->Wrapper{valalign=when(block.optString("align")){"start"->Arrangement.Start"end"->Arrangement.End"space_between"->Arrangement.SpaceBetween"space_around"->Arrangement.SpaceAround"space_evenly"->Arrangement.SpaceEvenlyelse->Arrangement.Center}valbuttons=block.optJSONArray("buttons")?:JSONArray()Row(Modifier.fillMaxWidth().horizontalScroll(rememberScrollState()),horizontalArrangement=align){for(iin0untilbuttons.length()){valbtn=buttons.optJSONObject(i)?:continuevallabel=btn.optString("label","Button")valstyleKey=btn.optString("style","primary")valaction=btn.optString("actionId","")valconfirm=btn.optBoolean("confirm",false)valsizeKey=btn.optString("size","md")valtintKey=btn.optString("tint","default")valshapeKey=btn.optString("shape","rounded")valcorner=btn.optDouble("corner",20.0).toFloat().dpvalpressKey=btn.optString("pressEffect","none")valicon=btn.optString("icon","")valinteraction=remember{MutableInteractionSource()}valpressedbyinteraction.collectIsPressedAsState()valscalebyanimateFloatAsState(targetValue=if(pressKey=="scale"&&pressed)0.96felse1f,label="btnScale")valalphabyanimateFloatAsState(targetValue=if(pressKey=="alpha"&&pressed)0.6felse1f,label="btnAlpha")valrotationbyanimateFloatAsState(targetValue=if(pressKey=="rotate"&&pressed)-2felse0f,label="btnRot")valshape=when(shapeKey){"pill"->RoundedCornerShape(50)"cut"->CutCornerShape(corner)else->RoundedCornerShape(corner)}var(container,content,border)=mapButtonColors(styleKey,tintKey)run{val__hex=btn.optString("customColor","")val__col=parseColorOrRole(__hex)if(__col!=null){container=__colcontent=bestOnColor(__col)}}valbaseMod=Modifier.graphicsLayer(scaleX=scale,scaleY=scale,alpha=alpha,rotationZ=rotation).then(if(!btn.optDouble("heightDp",Double.NaN).isNaN())Modifier.height(btn.optDouble("heightDp",Double.NaN).toFloat().dp)elsesizeModifier(sizeKey))Spacer(Modifier.width(6.dp))valcontentSlot:@Composable()->Unit={if(icon.isNotBlank()){IconText(label=label,icon=icon)}else{Text(label)}}when(styleKey){"outlined"->OutlinedButton(onClick={if(!confirm)dispatch(action)elsedispatch(action)},shape=shape,border=BorderStroke(border,content),colors=ButtonDefaults.outlinedButtonColors(contentColor=content),interactionSource=interaction,modifier=baseMod){contentSlot()}"tonal"->FilledTonalButton(onClick={dispatch(action)},shape=shape,colors=ButtonDefaults.filledTonalButtonColors(containerColor=container,contentColor=content),interactionSource=interaction,modifier=baseMod){contentSlot()}"text"->TextButton(onClick={dispatch(action)},shape=shape,colors=ButtonDefaults.textButtonColors(contentColor=content),interactionSource=interaction,modifier=baseMod){contentSlot()}else->Button(onClick={dispatch(action)},shape=shape,colors=ButtonDefaults.buttonColors(containerColor=container,contentColor=content),interactionSource=interaction,modifier=baseMod){contentSlot()}}}}}"ChipRow"->Wrapper{valchips=block.optJSONArray("chips")?:JSONArray()valisSingle=(0untilchips.length()).any{chips.optJSONObject(it)?.has("value")==true}Row(horizontalArrangement=Arrangement.spacedBy(8.dp)){for(iin0untilchips.length()){valc=chips.optJSONObject(i)?:continuevallabel=c.optString("label","")valbind=c.optString("bind","")if(isSingle){valv=c.opt("value")?.toString()?:""valcurrent=uiState[bind]?.toString()FilterChip(selected=current==v,onClick={uiState[bind]=v},label={Text(label,style=applyTextStyleOverrides(block,MaterialTheme.typography.bodyMedium),color=parseColorOrRole(block.optString("textColor",""))?:LocalContentColor.current)},leadingIcon=if(current==v){{Icon(Icons.Filled.Check,null)}}elsenull)}else{valcurrent=(uiState[bind]as?Boolean)?:falseFilterChip(selected=current,onClick={uiState[bind]=!current},label={Text(label,style=applyTextStyleOverrides(block,MaterialTheme.typography.bodyMedium),color=parseColorOrRole(block.optString("textColor",""))?:LocalContentColor.current)},leadingIcon=if(current){{Icon(Icons.Filled.Check,null)}}elsenull)}}}}"Toggle"->Wrapper{vallabel=block.optString("label","")valbind=block.optString("bind","")valv=(uiState[bind]as?Boolean)?:falseRow(verticalAlignment=Alignment.CenterVertically){Switch(checked=v,onCheckedChange={uiState[bind]=it})Spacer(Modifier.width(8.dp))Text(label)}}"Slider"->Wrapper{vallabel=block.optString("label","")valbind=block.optString("bind","")valmin=block.optDouble("min",0.0).toFloat()valmax=block.optDouble("max",10.0).toFloat()valstep=block.optDouble("step",1.0).toFloat()varvaluebyremember{mutableStateOf(((uiState[bind]as?Number)?.toFloat())?:min)}Text("$label:${"%.1f".format(value)}${block.optString("unit","")}")Slider(value=value,onValueChange={value=ituiState[bind]=if(step>=1f)round(it/step)*stepelseit},valueRange=min..max)}"List"->Wrapper{valitems=block.optJSONArray("items")?:JSONArray()Column{for(iin0untilitems.length()){valitem=items.optJSONObject(i)?:continueListItem(headlineContent={Text(item.optString("title",""),style=applyTextStyleOverrides(block,MaterialTheme.typography.bodyLarge),color=parseColorOrRole(block.optString("textColor",""))?:LocalContentColor.current)},supportingContent={valsub=item.optString("subtitle","")if(sub.isNotBlank())Text(sub,style=applyTextStyleOverrides(block,MaterialTheme.typography.bodyMedium),color=parseColorOrRole(block.optString("textColor",""))?:LocalContentColor.current)},modifier=Modifier.fillMaxWidth().padding(vertical=4.dp).clickable(onClick={dispatch(item.optString("actionId",""))}))Divider()}}}"Carousel"->Wrapper{ElevatedCard(Modifier.fillMaxWidth()){Column(Modifier.padding(16.dp)){Text("Carousel(placeholder)",style=MaterialTheme.typography.titleSmall)Text("Leimmaginisarannogestiteinunafasesuccessiva.")}}}"Fab"->Wrapper{valicon=block.optString("icon","play_arrow")vallabel=block.optString("label","")valsize=block.optString("size","regular")valvariant=block.optString("variant","regular")valaction=block.optString("actionId","")Row(Modifier.fillMaxWidth(),horizontalArrangement=Arrangement.End){when(variant){"extended"->ExtendedFloatingActionButton(onClick={dispatch(action)},icon={NamedIconEx(icon,null)},text={Text(label.ifBlank{"Azione"})})else->when(size){"small"->SmallFloatingActionButton(onClick={dispatch(action)}){NamedIconEx(icon,null)}"large"->LargeFloatingActionButton(onClick={dispatch(action)}){NamedIconEx(icon,null)}else->FloatingActionButton(onClick={dispatch(action)}){NamedIconEx(icon,null)}}}}}"Divider"->{valthick=block.optDouble("thickness",1.0).toFloat().dpvalpadStart=block.optDouble("padStart",0.0).toFloat().dpvalpadEnd=block.optDouble("padEnd",0.0).toFloat().dpDivider(modifier=Modifier.padding(start=padStart,end=padEnd),thickness=thick)}"DividerV"->{valthickness=block.optDouble("thickness",1.0).toFloat().dpvalheight=block.optDouble("height",24.0).toFloat().dpVerticalDivider(modifier=Modifier.height(height),thickness=thickness)}"Spacer"->{Spacer(Modifier.height((block.optDouble("height",8.0)).toFloat().dp))}"Menu"->{if(designerMode){ElevatedCard{Text("Menu:${block.optString("id")}(${block.optJSONArray("items")?.length()?:0}voci)",Modifier.padding(8.dp))}}}else->{if(designerMode){Surface(tonalElevation=1.dp){Text("Bloccononsupportato:${block.optString("type")}",color=Color.Red)}}}}}/*=========================*GRID*=========================*/@ComposableprivatefunGridSection(tiles:JSONArray,cols:Int,uiState:MutableMap<String,Any>){valrows=mutableListOf<List<JSONObject>>()varcurrent=mutableListOf<JSONObject>()for(iin0untiltiles.length()){tiles.optJSONObject(i)?.let{current.add(it)}if(current.size==cols){rows.add(current.toList());current=mutableListOf()}}if(current.isNotEmpty())rows.add(current)Column(verticalArrangement=Arrangement.spacedBy(8.dp)){rows.forEach{row->Row(Modifier.fillMaxWidth(),horizontalArrangement=Arrangement.spacedBy(8.dp)){row.forEach{t->ElevatedCard(Modifier.weight(1f)){Column(Modifier.padding(12.dp)){Text(t.optString("label",""),style=MaterialTheme.typography.labelMedium)Text("—",style=MaterialTheme.typography.headlineSmall)}}}repeat((cols-row.size).coerceAtLeast(0)){Spacer(Modifier.weight(1f))}}}}}/*=========================*DESIGNEROVERLAY*=========================*/@ComposableprivatefunBoxScope.DesignerOverlay(screenName:String,layout:JSONObject,selectedPath:String?,setSelectedPath:(String?)->Unit,onLiveChange:()->Unit,onLayoutChange:()->Unit,onSaveDraft:()->Unit,onPublish:()->Unit,onReset:()->Unit,onOverlayHeight:(Int)->Unit){varshowInspectorbyremember{mutableStateOf(false)}valselectedBlock=selectedPath?.let{jsonAtPath(layout,it)as?JSONObject}valcanMove=selectedPath?.let{getParentAndIndex(layout,it)!=null}==trueColumn(Modifier.align(Alignment.BottomCenter).fillMaxWidth().padding(12.dp).onGloballyPositioned{onOverlayHeight(it.size.height)},verticalArrangement=Arrangement.spacedBy(8.dp)){//PaletteSurface(shape=RoundedCornerShape(16.dp),tonalElevation=8.dp){Row(Modifier.padding(10.dp).horizontalScroll(rememberScrollState()),horizontalArrangement=Arrangement.spacedBy(8.dp),verticalAlignment=Alignment.CenterVertically){Text("Palette:",style=MaterialTheme.typography.labelLarge)FilledTonalButton(onClick={valpath=insertBlockAndReturnPath(layout,selectedPath,newSectionHeader(),"after")setSelectedPath(path);onLayoutChange()}){Icon(Icons.Filled.LibraryAdd,null);Spacer(Modifier.width(6.dp));Text("SectionHeader")}FilledTonalButton(onClick={valpath=insertBlockAndReturnPath(layout,selectedPath,newButtonRow(),"after")setSelectedPath(path);onLayoutChange()}){Icon(Icons.Filled.LibraryAdd,null);Spacer(Modifier.width(6.dp));Text("ButtonRow")}FilledTonalButton(onClick={valpath=insertBlockAndReturnPath(layout,selectedPath,newSpacer(),"after")setSelectedPath(path);onLayoutChange()}){Icon(Icons.Filled.LibraryAdd,null);Spacer(Modifier.width(6.dp));Text("Spacer")}FilledTonalButton(onClick={valpath=insertBlockAndReturnPath(layout,selectedPath,JSONObject().put("type","Divider"),"after")setSelectedPath(path);onLayoutChange()}){Icon(Icons.Filled.LibraryAdd,null);Spacer(Modifier.width(6.dp));Text("Divider")}FilledTonalButton(onClick={valiconPath=insertIconMenuReturnIconPath(layout,selectedPath)setSelectedPath(iconPath)onLayoutChange()}){Icon(Icons.Filled.MoreVert,null);Spacer(Modifier.width(6.dp));Text("Icon+Menu")}FilledTonalButton(onClick={valpath=insertBlockAndReturnPath(layout,selectedPath,newCard(),"after")setSelectedPath(path);onLayoutChange()}){Icon(Icons.Filled.Widgets,null);Spacer(Modifier.width(6.dp));Text("Card")}FilledTonalButton(onClick={valpath=insertBlockAndReturnPath(layout,selectedPath,newFab(),"after")setSelectedPath(path);onLayoutChange()}){Icon(Icons.Filled.PlayArrow,null);Spacer(Modifier.width(6.dp));Text("Fab")}FilledTonalButton(onClick={valpath=insertBlockAndReturnPath(layout,selectedPath,newDividerV(),"after")setSelectedPath(path);onLayoutChange()}){Icon(Icons.Filled.MoreHoriz,null);Spacer(Modifier.width(6.dp));Text("DividerV")}}}//Selezione+AzionisalvataggioSurface(shape=RoundedCornerShape(16.dp),tonalElevation=8.dp){Column(Modifier.padding(10.dp).fillMaxWidth(),verticalArrangement=Arrangement.spacedBy(8.dp)){Row(modifier=Modifier.fillMaxWidth().horizontalScroll(rememberScrollState()),horizontalArrangement=Arrangement.spacedBy(8.dp),verticalAlignment=Alignment.CenterVertically){Text("Selezione:",style=MaterialTheme.typography.labelLarge)OutlinedButton(onClick={valnewPath=moveAndReturnNewPath(layout,selectedPath!!,-1)setSelectedPath(newPath);onLayoutChange()}){Icon(Icons.Filled.KeyboardArrowUp,null);Spacer(Modifier.width(4.dp));Text("Su")}OutlinedButton(onClick={valnewPath=moveAndReturnNewPath(layout,selectedPath!!,+1)setSelectedPath(newPath);onLayoutChange()}){Icon(Icons.Filled.KeyboardArrowDown,null);Spacer(Modifier.width(4.dp));Text("Giu")}OutlinedButton(onClick={duplicate(layout,selectedPath!!);onLayoutChange()}){Icon(Icons.Filled.ContentCopy,null);Spacer(Modifier.width(4.dp));Text("Duplica")}TextButton(onClick={remove(layout,selectedPath!!);setSelectedPath(null);onLayoutChange()},colors=ButtonDefaults.textButtonColors(contentColor=MaterialTheme.colorScheme.error)){Icon(Icons.Filled.Delete,null);Spacer(Modifier.width(4.dp));Text("Elimina")}Button(onClick={showInspector=true}){Text("Proprietà...")}}Row(modifier=Modifier.fillMaxWidth(),horizontalArrangement=Arrangement.End,verticalAlignment=Alignment.CenterVertically){OutlinedButton(onClick=onSaveDraft){Text("Salvabozza")}Spacer(Modifier.width(8.dp))Button(onClick=onPublish){Text("Pubblica")}Spacer(Modifier.width(8.dp))TextButton(onClick=onReset){Text("Reset")}}}}}if(showInspector&&selectedBlock!=null&&selectedPath!=null){//Ogniinspector://-sheettrasparente(containerColoralpha0.85)//-anteprimalive:onLiveChange()suognimodifica//-OK/ANNULLA:suannullaripristinabackupvalonApply={showInspector=false;onLayoutChange()}valonCancel={showInspector=false;onLiveChange()}//giàripristinatodentroinspectorwhen(selectedBlock.optString("type")){"ButtonRow"->ButtonRowInspector(layout,selectedPath,onApply,onCancel,onLiveChange)"SectionHeader"->SectionHeaderInspector(layout,selectedPath,onApply,onCancel,onLiveChange)"Spacer"->SpacerInspector(layout,selectedPath,onApply,onCancel,onLiveChange)"Divider"->DividerInspector(layout,selectedPath,onApply,onCancel,onLiveChange)"DividerV"->DividerVInspector(layout,selectedPath,onApply,onCancel,onLiveChange)"Card"->CardInspector(layout,selectedPath,onApply,onCancel,onLiveChange)"Fab"->FabInspector(layout,selectedPath,onApply,onCancel,onLiveChange)"IconButton"->IconButtonInspector(layout,selectedPath,onApply,onCancel,onLiveChange)"List"->ListInspector(layout,selectedPath,onApply,onCancel,onLiveChange)"ChipRow"->ChipRowInspector(layout,selectedPath,onApply,onCancel,onLiveChange)}}}/*=========================*INSPECTORS(trasparenti+livepreview+ok/annulla)*=========================*/@Composable@Composable@ComposableprivatefunButtonRowInspector(layout:JSONObject,path:String,onApply:()->Unit,onCancel:()->Unit,onLive:()->Unit){varopenbyremember{mutableStateOf(true)}valblock=(jsonAtPath(layout,path)asJSONObject)valbackup=remember{JSONObject(block.toString())}funcloseApply(){open=false;onApply()}funcloseCancel(){replaceAtPath(layout,path,backup);open=false;onCancel()}ModalBottomSheet(onDismissRequest={closeCancel()},containerColor=MaterialTheme.colorScheme.surface.copy(alpha=0.30f),//moltotrasparentescrimColor=Color.Black.copy(alpha=0.18f)){valbuttons=block.optJSONArray("buttons")?:JSONArray().also{block.put("buttons",it)}Column(Modifier.fillMaxWidth().verticalScroll(rememberScrollState()).padding(16.dp),verticalArrangement=Arrangement.spacedBy(12.dp)){Text("ButtonRow–Proprietàriga",style=MaterialTheme.typography.titleMedium)varalignbyremember{mutableStateOf(block.optString("align","center"))}ExposedDropdown(value=align,label="align",options=listOf("start","center","end","space_between","space_around","space_evenly")){sel->align=selblock.put("align",sel)onLive()}Divider()Text("Bottoni",style=MaterialTheme.typography.titleMedium)for(iin0untilbuttons.length()){valbtn=buttons.getJSONObject(i)ElevatedCard(colors=CardDefaults.elevatedCardColors(containerColor=MaterialTheme.colorScheme.surface.copy(alpha=0.26f)//cardquasi“solocontorno”)){Column(Modifier.padding(12.dp),verticalArrangement=Arrangement.spacedBy(8.dp)){Row(horizontalArrangement=Arrangement.SpaceBetween,verticalAlignment=Alignment.CenterVertically,modifier=Modifier.fillMaxWidth()){Text("Bottone${i+1}",style=MaterialTheme.typography.labelLarge)Row{IconButton(onClick={moveInArray(buttons,i,-1);onLive()}){Icon(Icons.Filled.KeyboardArrowUp,contentDescription=null)}IconButton(onClick={moveInArray(buttons,i,+1);onLive()}){Icon(Icons.Filled.KeyboardArrowDown,contentDescription=null)}IconButton(onClick={removeAt(buttons,i);onLive()}){Icon(Icons.Filled.Close,contentDescription=null,tint=MaterialTheme.colorScheme.error)}}}vallabel=remember{mutableStateOf(btn.optString("label",""))}valicon=remember{mutableStateOf(btn.optString("icon",""))}varstylebyremember{mutableStateOf(btn.optString("style","primary"))}varsizebyremember{mutableStateOf(btn.optString("size","md"))}//manterremomappaturalegacy(sm/md/lg)valcornerStr=remember{mutableStateOf(btn.optDouble("corner",20.0).toString())}varpressbyremember{mutableStateOf(if(btn.optString("pressEffect","none")=="scale")"scale"else"none")}valaction=remember{mutableStateOf(btn.optString("actionId",""))}valcustomColor=remember{mutableStateOf(btn.optString("customColor",""))}OutlinedTextField(value=label.value,onValueChange={label.value=it;btn.put("label",it);onLive()},label={Text("label")})IconPickerField(value=icon,label="icon"){sel->icon.value=sel;btn.put("icon",sel);onLive()}ExposedDropdown(value=style,label="style",options=listOf("primary","tonal","outlined","text")){style=it;btn.put("style",it);onLive()}//Dimensionepiùgranulare(peroracompatibileconrender:xs->sm,xl->lgviamappingfuturo)ExposedDropdown(value=size,label="size",options=listOf("xs","sm","md","lg","xl")){sel->size=sel;btn.put("size",sel);onLive()}//Cornerconstep1StepperField(label="corner(dp)",state=cornerStr,step=1.0){v->btn.put("corner",v);onLive()}//SolocustomColor(overridecompleto,conpalette)NamedColorPicker(currentHexOrEmpty=customColor.value,label="customColor(palette)",onPickHex={hex->customColor.value=hexif(hex.isBlank())btn.remove("customColor")elsebtn.put("customColor",hex)onLive()})//Presseffectsestesi(inrenderèattivo'scale';glialtrisonono-opalmomento)ExposedDropdown(value=press,label="pressEffect",options=listOf("none","scale","glow","tilt")){sel->press=sel;btn.put("pressEffect",sel);onLive()}OutlinedTextField(value=action.value,onValueChange={action.value=it;btn.put("actionId",it);onLive()},label={Text("actionId(es.nav:settings)")})}}}Row(horizontalArrangement=Arrangement.spacedBy(8.dp)){Button(onClick={buttons.put(JSONObject("{\"label\":\"Nuovo\",\"style\":\"text\",\"icon\":\"add\",\"actionId\":\"\"}"))onLive()}){Text("+Aggiungibottone")}Spacer(Modifier.weight(1f))TextButton(onClick={closeCancel()}){Text("Annulla")}Button(onClick={closeApply()}){Text("OK")}}Spacer(Modifier.height(24.dp))}}}@Composable@ComposableprivatefunSectionHeaderInspector(layout:JSONObject,path:String,onApply:()->Unit,onCancel:()->Unit,onLive:()->Unit){varopenbyremember{mutableStateOf(true)}valblock=(jsonAtPath(layout,path)asJSONObject)valbackup=remember{JSONObject(block.toString())}funcloseApply(){open=false;onApply()}funcloseCancel(){replaceAtPath(layout,path,backup)open=falseonCancel()}ModalBottomSheet(onDismissRequest={closeCancel()},containerColor=MaterialTheme.colorScheme.surface.copy(alpha=0.20f),scrimColor=Color.Black.copy(alpha=0.32f)){valtitle=remember{mutableStateOf(block.optString("title",""))}valsubtitle=remember{mutableStateOf(block.optString("subtitle",""))}varstylebyremember{mutableStateOf(block.optString("style","titleMedium"))}varalignbyremember{mutableStateOf(block.optString("align","start"))}valspaceTop=remember{mutableStateOf(block.optDouble("spaceTop",0.0).toString())}valspaceBottom=remember{mutableStateOf(block.optDouble("spaceBottom",0.0).toString())}valpadStart=remember{mutableStateOf(block.optDouble("padStart",0.0).toString())}valpadEnd=remember{mutableStateOf(block.optDouble("padEnd",0.0).toString())}valclickAction=remember{mutableStateOf(block.optString("clickActionId",""))}vartextColorbyremember{mutableStateOf(block.optString("textColor",""))}Column(Modifier.fillMaxWidth().verticalScroll(rememberScrollState()).padding(16.dp),verticalArrangement=Arrangement.spacedBy(12.dp)){Text("SectionHeader-Proprietà",style=MaterialTheme.typography.titleMedium)OutlinedTextField(value=title.value,onValueChange={title.value=it;block.put("title",it);onLive()},label={Text("Titolo")})OutlinedTextField(value=subtitle.value,onValueChange={subtitle.value=it;block.put("subtitle",it);onLive()},label={Text("Sottotitolo(opz.)")})ExposedDropdown(value=style,label="style",options=listOf("displaySmall","headlineSmall","titleLarge","titleMedium","titleSmall","bodyLarge","bodyMedium")){style=it;block.put("style",it);onLive()}ExposedDropdown(value=align,label="align",options=listOf("start","center","end")){align=it;block.put("align",it);onLive()}//ColoretestoonLive()}//TipografiagranularevaltextSize=remember{mutableStateOf(block.optDouble("textSizeSp",Double.NaN).let{if(it.isNaN())""elseit.toString()})}varfontFamilybyremember{mutableStateOf(block.optString("fontFamily",""))}varfontWeightbyremember{mutableStateOf(block.optString("fontWeight",""))}ExposedDropdown(value=if(textSize.value.isBlank())"(default)"elsetextSize.value,label="textsize(sp)",options=listOf("(default)","8","9","10","11","12","14","16","18","20","22","24","28","32","36")){valv=if(it=="(default)")""elseittextSize.value=vif(v.isBlank()){block.remove("textSizeSp")}else{block.put("textSizeSp",v.toDouble())}onLive()}Divider()Text("Azionealtap",style=MaterialTheme.typography.titleMedium)OutlinedTextField(value=clickAction.value,onValueChange={clickAction.value=it;block.put("clickActionId",it);onLive()},label={Text("clickActionId(es.nav:settings)")})Row(horizontalArrangement=Arrangement.spacedBy(8.dp)){Spacer(Modifier.weight(1f))TextButton(onClick={closeCancel()}){Text("Annulla")}Button(onClick={closeApply()}){Text("OK")}}Spacer(Modifier.height(12.dp))}}}@Composable@Composable@ComposableprivatefunSpacerInspector(layout:JSONObject,path:String,onApply:()->Unit,onCancel:()->Unit,onLive:()->Unit){varopenbyremember{mutableStateOf(true)}valblock=(jsonAtPath(layout,path)asJSONObject)valbackup=remember{JSONObject(block.toString())}funcloseApply(){open=false;onApply()}funcloseCancel(){replaceAtPath(layout,path,backup);open=false;onCancel()}ModalBottomSheet(onDismissRequest={closeCancel()},containerColor=MaterialTheme.colorScheme.surface.copy(alpha=0.20f),scrimColor=Color.Black.copy(alpha=0.32f)){valheight=remember{mutableStateOf(block.optDouble("height",8.0).toString())}Column(Modifier.fillMaxWidth().padding(16.dp),verticalArrangement=Arrangement.spacedBy(12.dp)){Text("Spacer-Proprietà",style=MaterialTheme.typography.titleMedium)StepperField("height(dp)",height,2.0){v->block.put("height",v);onLive()}Row{Spacer(Modifier.weight(1f))TextButton(onClick={closeCancel()}){Text("Annulla")}Button(onClick={closeApply()}){Text("OK")}}}}}@Composable@Composable@ComposableprivatefunDividerInspector(layout:JSONObject,path:String,onApply:()->Unit,onCancel:()->Unit,onLive:()->Unit){varopenbyremember{mutableStateOf(true)}valblock=(jsonAtPath(layout,path)asJSONObject)valbackup=remember{JSONObject(block.toString())}funcloseApply(){open=false;onApply()}funcloseCancel(){replaceAtPath(layout,path,backup);open=false;onCancel()}ModalBottomSheet(onDismissRequest={closeCancel()},containerColor=MaterialTheme.colorScheme.surface.copy(alpha=0.20f),scrimColor=Color.Black.copy(alpha=0.32f)){valthickness=remember{mutableStateOf(block.optDouble("thickness",1.0).toString())}valpadStart=remember{mutableStateOf(block.optDouble("padStart",0.0).toString())}valpadEnd=remember{mutableStateOf(block.optDouble("padEnd",0.0).toString())}Column(Modifier.fillMaxWidth().padding(16.dp),verticalArrangement=Arrangement.spacedBy(12.dp)){Text("Divider-Proprietà",style=MaterialTheme.typography.titleMedium)StepperField("thickness(dp)",thickness,1.0){v->block.put("thickness",v);onLive()}StepperField("padStart(dp)",padStart,2.0){v->block.put("padStart",v);onLive()}StepperField("padEnd(dp)",padEnd,2.0){v->block.put("padEnd",v);onLive()}Row{Spacer(Modifier.weight(1f))TextButton(onClick={closeCancel()}){Text("Annulla")}Button(onClick={closeApply()}){Text("OK")}}}}}@Composable@Composable@ComposableprivatefunDividerVInspector(layout:JSONObject,path:String,onApply:()->Unit,onCancel:()->Unit,onLive:()->Unit){varopenbyremember{mutableStateOf(true)}valblock=(jsonAtPath(layout,path)asJSONObject)valbackup=remember{JSONObject(block.toString())}funcloseApply(){open=false;onApply()}funcloseCancel(){replaceAtPath(layout,path,backup);open=false;onCancel()}ModalBottomSheet(onDismissRequest={closeCancel()},containerColor=MaterialTheme.colorScheme.surface.copy(alpha=0.20f),scrimColor=Color.Black.copy(alpha=0.32f)){valthickness=remember{mutableStateOf(block.optDouble("thickness",1.0).toString())}valheight=remember{mutableStateOf(block.optDouble("height",24.0).toString())}Column(Modifier.fillMaxWidth().padding(16.dp),verticalArrangement=Arrangement.spacedBy(12.dp)){Text("DividerV-Proprietà",style=MaterialTheme.typography.titleMedium)StepperField("thickness(dp)",thickness,1.0){v->block.put("thickness",v);onLive()}StepperField("height(dp)",height,2.0){v->block.put("height",v);onLive()}Row{Spacer(Modifier.weight(1f))TextButton(onClick={closeCancel()}){Text("Annulla")}Button(onClick={closeApply()}){Text("OK")}}}}}@Composable@Composable@ComposableprivatefunCardInspector(layout:JSONObject,path:String,onApply:()->Unit,onCancel:()->Unit,onLive:()->Unit){varopenbyremember{mutableStateOf(true)}valblock=(jsonAtPath(layout,path)asJSONObject)valbackup=remember{JSONObject(block.toString())}funcloseApply(){open=false;onApply()}funcloseCancel(){replaceAtPath(layout,path,backup);open=false;onCancel()}ModalBottomSheet(onDismissRequest={closeCancel()},containerColor=MaterialTheme.colorScheme.surface.copy(alpha=0.20f),scrimColor=Color.Black.copy(alpha=0.32f)){varvariantbyremember{mutableStateOf(block.optString("variant","elevated"))}valaction=remember{mutableStateOf(block.optString("clickActionId",""))}Column(Modifier.fillMaxWidth().padding(16.dp),verticalArrangement=Arrangement.spacedBy(12.dp)){Text("Card-Proprietà",style=MaterialTheme.typography.titleMedium)ExposedDropdown(value=variant,label="variant",options=listOf("elevated","outlined","filled")){variant=it;block.put("variant",it);onLive()}OutlinedTextField(value=action.value,onValueChange={action.value=it;block.put("clickActionId",it);onLive()},label={Text("clickActionId(es.nav:run)")})Row{Spacer(Modifier.weight(1f))TextButton(onClick={closeCancel()}){Text("Annulla")}Button(onClick={closeApply()}){Text("OK")}}}}}@Composable@Composable@ComposableprivatefunFabInspector(layout:JSONObject,path:String,onApply:()->Unit,onCancel:()->Unit,onLive:()->Unit){varopenbyremember{mutableStateOf(true)}valblock=(jsonAtPath(layout,path)asJSONObject)valbackup=remember{JSONObject(block.toString())}funcloseApply(){open=false;onApply()}funcloseCancel(){replaceAtPath(layout,path,backup);open=false;onCancel()}ModalBottomSheet(onDismissRequest={closeCancel()},containerColor=MaterialTheme.colorScheme.surface.copy(alpha=0.20f),scrimColor=Color.Black.copy(alpha=0.32f)){valicon=remember{mutableStateOf(block.optString("icon","play_arrow"))}vallabel=remember{mutableStateOf(block.optString("label","Start"))}varvariantbyremember{mutableStateOf(block.optString("variant","regular"))}varsizebyremember{mutableStateOf(block.optString("size","regular"))}valaction=remember{mutableStateOf(block.optString("actionId","start_run"))}Column(Modifier.fillMaxWidth().padding(16.dp),verticalArrangement=Arrangement.spacedBy(12.dp)){Text("Fab-Proprietà",style=MaterialTheme.typography.titleMedium)IconPickerField(icon,"icon"){sel->icon.value=sel;block.put("icon",sel);onLive()}OutlinedTextField(value=label.value,onValueChange={label.value=it;block.put("label",it);onLive()},label={Text("label")})ExposedDropdown(value=variant,label="variant",options=listOf("regular","extended")){variant=it;block.put("variant",it);onLive()}ExposedDropdown(value=size,label="size",options=listOf("small","regular","large")){size=it;block.put("size",it);onLive()}OutlinedTextField(value=action.value,onValueChange={action.value=it;block.put("actionId",it);onLive()},label={Text("actionId")})Row{Spacer(Modifier.weight(1f))TextButton(onClick={closeCancel()}){Text("Annulla")}Button(onClick={closeApply()}){Text("OK")}}}}}@Composable@Composable@ComposableprivatefunIconButtonInspector(layout:JSONObject,path:String,onApply:()->Unit,onCancel:()->Unit,onLive:()->Unit){varopenbyremember{mutableStateOf(true)}valblock=(jsonAtPath(layout,path)asJSONObject)valbackup=remember{JSONObject(block.toString())}funcloseApply(){open=false;onApply()}funcloseCancel(){replaceAtPath(layout,path,backup);open=false;onCancel()}ModalBottomSheet(onDismissRequest={closeCancel()},containerColor=MaterialTheme.colorScheme.surface.copy(alpha=0.20f),scrimColor=Color.Black.copy(alpha=0.32f)){valicon=remember{mutableStateOf(block.optString("icon","more_vert"))}valaction=remember{mutableStateOf(block.optString("actionId",""))}valopenMenuId=remember{mutableStateOf(block.optString("openMenuId",""))}Column(Modifier.fillMaxWidth().padding(16.dp),verticalArrangement=Arrangement.spacedBy(12.dp)){Text("IconButton-Proprietà",style=MaterialTheme.typography.titleMedium)IconPickerField(icon,"icon"){sel->icon.value=sel;block.put("icon",sel);onLive()}OutlinedTextField(value=action.value,onValueChange={action.value=it;block.put("actionId",it);onLive()},label={Text("actionId(es.nav:settingsoopen_menu:<id>)")})OutlinedTextField(value=openMenuId.value,onValueChange={openMenuId.value=it;block.put("openMenuId",it);onLive()},label={Text("openMenuId(senonusiactionId=open_menu:...)")})Row{Spacer(Modifier.weight(1f))TextButton(onClick={closeCancel()}){Text("Annulla")}Button(onClick={closeApply()}){Text("OK")}}}}}/*=========================*HELPERS:mapping,pickers,utils*=========================*/@ComposableprivatefunmapTextStyle(key:String):TextStyle=when(key){"displaySmall"->MaterialTheme.typography.displaySmall"headlineSmall"->MaterialTheme.typography.headlineSmall"titleLarge"->MaterialTheme.typography.titleLarge"titleSmall"->MaterialTheme.typography.titleSmall"bodyLarge"->MaterialTheme.typography.bodyLarge"bodyMedium"->MaterialTheme.typography.bodyMediumelse->MaterialTheme.typography.titleMedium}@ComposableprivatefunmapTextAlign(key:String):TextAlign=when(key){"center"->TextAlign.Center"end"->TextAlign.Endelse->TextAlign.Start}privatefunsizeModifier(size:String):Modifier=when(size){"sm"->Modifier.height(36.dp)"lg"->Modifier.height(52.dp)else->Modifier.height(40.dp)}@ComposableprivatefunIconText(label:String,icon:String){Row(verticalAlignment=Alignment.CenterVertically,horizontalArrangement=Arrangement.spacedBy(8.dp)){NamedIconEx(icon,null)Text(label)}}@ComposableprivatefunmapButtonColors(style:String,tint:String):Triple<Color,Color,Dp>{valcs=MaterialTheme.colorSchemeval(baseContainer,baseContent)=when(tint){"success"->cs.tertiarytocs.onTertiary"warning"->Color(0xFFFFD54F)toColor(0xFF3E2723)"error"->cs.errorContainertocs.onErrorContainerelse->cs.primarytocs.onPrimary}returnwhen(style){"outlined"->Triple(Color.Transparent,when(tint){"success"->cs.tertiary"warning"->Color(0xFF8D6E63)"error"->cs.errorelse->cs.primary},1.dp)"text"->Triple(Color.Transparent,when(tint){"success"->cs.tertiary"warning"->Color(0xFF8D6E63)"error"->cs.errorelse->cs.primary},0.dp)"tonal"->Triple(cs.secondaryContainer,cs.onSecondaryContainer,0.dp)else->Triple(baseContainer,baseContent,0.dp)}}/*----Pickers----*/privatevalICONS=listOf("settings","more_vert","tune","play_arrow","pause","stop","add","flag","queue_music","widgets","palette","home","menu","close","more_horiz","directions_run","directions_walk","directions_bike","fitness_center","timer","timer_off","watch_later","map","my_location","place","speed","bolt","local_fire_department","sports_score")@ComposableprivatefunIconPickerField(value:MutableState<String>,label:String,onSelected:(String)->Unit){varexpandedbyremember{mutableStateOf(false)}ExposedDropdownMenuBox(expanded=expanded,onExpandedChange={expanded=!expanded}){OutlinedTextField(value=value.value,onValueChange={},readOnly=true,label={Text(label,style=MaterialTheme.typography.bodyMedium,color=LocalContentColor.current)},trailingIcon={ExposedDropdownMenuDefaults.TrailingIcon(expanded=expanded)},leadingIcon={if(value.value.isNotBlank())NamedIconEx(value.value,null)},modifier=Modifier.menuAnchor())ExposedDropdownMenu(expanded=expanded,onDismissRequest={expanded=false}){ICONS.forEach{name->DropdownMenuItem(text={Text(name)},leadingIcon={NamedIconEx(name,null)},onClick={onSelected(name);expanded=false})}}}}privatevalCOLOR_ROLES_WITH_EMPTY=listOf("","primary","onPrimary","secondary","onSecondary","tertiary","onTertiary","error","onError","surface","onSurface")@ComposableprivatefunColorRolePicker(value:String,label:String,options:List<String>,onSelect:(String)->Unit){varexpandedbyremember{mutableStateOf(false)}valdisplay=if(value.isBlank())"(default)"elsevalueExposedDropdownMenuBox(expanded=expanded,onExpandedChange={expanded=!expanded}){OutlinedTextField(value=display,onValueChange={},readOnly=true,label={Text(label,style=MaterialTheme.typography.bodyMedium,color=LocalContentColor.current)},trailingIcon={ExposedDropdownMenuDefaults.TrailingIcon(expanded=expanded)},modifier=Modifier.menuAnchor())ExposedDropdownMenu(expanded=expanded,onDismissRequest={expanded=false}){options.forEach{opt->DropdownMenuItem(text={Text(if(opt.isBlank())"(default)"elseopt)},onClick={onSelect(opt);expanded=false})}}}}@ComposableprivatefunStepperField(label:String,state:MutableState<String>,step:Double=1.0,onChangeValue:(Double)->Unit){funcurrent():Double=state.value.toDoubleOrNull()?:0.0Column(verticalArrangement=Arrangement.spacedBy(4.dp)){Text(label,style=MaterialTheme.typography.labelMedium)Row(verticalAlignment=Alignment.CenterVertically,horizontalArrangement=Arrangement.spacedBy(8.dp)){OutlinedButton(onClick={valv=current()-stepstate.value="%.2f".format(max(v,-10000.0))onChangeValue(current())}){Text("-")}OutlinedTextField(value=state.value,onValueChange={state.value=itvalnum=it.toDoubleOrNull()if(num!=null)onChangeValue(num)},singleLine=true,modifier=Modifier.width(120.dp))OutlinedButton(onClick={valv=current()+stepstate.value="%.2f".format(min(v,10000.0))onChangeValue(current())}){Text("+")}}}}/*----Iconhelper----*/@ComposableprivatefunNamedIconEx(name:String?,contentDescription:String?){valimage=when(name){"settings"->Icons.Filled.Settings"more_vert"->Icons.Filled.MoreVert"tune"->Icons.Filled.Tune"play_arrow"->Icons.Filled.PlayArrow"pause"->Icons.Filled.Pause"stop"->Icons.Filled.Stop"add"->Icons.Filled.Add"flag"->Icons.Filled.Flag"queue_music"->Icons.Filled.QueueMusic"widgets"->Icons.Filled.Widgets"palette"->Icons.Filled.Palette"directions_run"->Icons.Filled.DirectionsRun"home"->Icons.Filled.Home"menu"->Icons.Filled.Menu"close"->Icons.Filled.Close"more_horiz"->Icons.Filled.MoreHorizelse->null}if(image!=null){Icon(image,contentDescription)}else{Text(".")}}/*----Colorparsing----*/@ComposableprivatefunparseColorOrRole(value:String?):Color?{if(value.isNullOrBlank())returnnullvalv=value.trim()//Hexif(v.startsWith("#")&&(v.length==7||v.length==9)){returntry{Color(android.graphics.Color.parseColor(v))}catch(_:Exception){null}}valcs=MaterialTheme.colorSchemereturnwhen(v){"primary"->cs.primary"onPrimary"->cs.onPrimary"secondary"->cs.secondary"onSecondary"->cs.onSecondary"tertiary"->cs.tertiary"onTertiary"->cs.onTertiary"error"->cs.error"onError"->cs.onError"surface"->cs.surface"onSurface"->cs.onSurfaceelse->null}}/*----JSONutils----*/privatefuncollectMenus(root:JSONObject):Map<String,JSONArray>{valmap=mutableMapOf<String,JSONArray>()funwalk(n:Any?){when(n){isJSONObject->{if(n.optString("type")=="Menu"){valid=n.optString("id","")valitems=n.optJSONArray("items")?:JSONArray()if(id.isNotBlank())map[id]=items}n.keys().forEachRemaining{key->walk(n.opt(key))}}isJSONArray->{for(iin0untiln.length())walk(n.opt(i))}}}walk(root)returnmap}privatefunjsonAtPath(root:JSONObject,path:String):Any?{if(!path.startsWith("/"))returnnullvalsegs=path.trim('/').split('/')varnode:Any=rootvari=0while(i<segs.size){when(node){isJSONObject->{node=(nodeasJSONObject).opt(segs[i])?:returnnull;i++}isJSONArray->{validx=segs[i].toIntOrNull()?:returnnullnode=(nodeasJSONArray).opt(idx)?:returnnulli++}else->returnnull}}returnnode}privatefungetParentAndIndex(root:JSONObject,path:String):Pair<JSONArray,Int>?{if(!path.startsWith("/"))returnnullvalsegs=path.trim('/').split('/')varnode:Any=rootvarparentArr:JSONArray?=nullvarindex=-1vari=0while(i<segs.size){vals=segs[i]when(node){isJSONObject->{node=(nodeasJSONObject).opt(s)?:returnnull;i++}isJSONArray->{validx=s.toIntOrNull()?:returnnullparentArr=nodeasJSONArrayindex=idxnode=parentArr.opt(idx)?:returnnulli++}}}returnif(parentArr!=null&&index>=0)parentArr!!toindexelsenull}privatefunreplaceAtPath(root:JSONObject,path:String,newNode:JSONObject){valp=getParentAndIndex(root,path)?:returnp.first.put(p.second,JSONObject(newNode.toString()))}privatefuninsertBlockAndReturnPath(root:JSONObject,selectedPath:String?,block:JSONObject,position:String):String{valparentArr:JSONArrayvalidx:IntvalparentPath:Stringif(selectedPath!=null){valpair=getParentAndIndex(root,selectedPath)if(pair!=null){parentArr=pair.firstidx=pair.secondparentPath=selectedPath.substringBeforeLast("/")}else{parentArr=root.optJSONArray("blocks")?:JSONArray().also{root.put("blocks",it)}idx=parentArr.length()-1parentPath="/blocks"}}else{parentArr=root.optJSONArray("blocks")?:JSONArray().also{root.put("blocks",it)}idx=parentArr.length()-1parentPath="/blocks"}valinsertIndex=when(position){"before"->idx;else->idx+1}.coerceIn(0,parentArr.length())valtmp=mutableListOf<Any?>()for(iin0untilparentArr.length()){if(i==insertIndex)tmp.add(block)tmp.add(parentArr.get(i))}if(insertIndex==parentArr.length())tmp.add(block)while(parentArr.length()>0)parentArr.remove(parentArr.length()-1)tmp.forEach{parentArr.put(it)}return"$parentPath/$insertIndex"}privatefuninsertIconMenuReturnIconPath(root:JSONObject,selectedPath:String?):String{valid="menu_"+System.currentTimeMillis().toString().takeLast(5)valiconPath=insertBlockAndReturnPath(root,selectedPath,newIconButton(id),"after")insertBlockAndReturnPath(root,iconPath,newMenu(id),"after")returniconPath}privatefunmoveAndReturnNewPath(root:JSONObject,path:String,delta:Int):String{valp=getParentAndIndex(root,path)?:returnpathval(arr,idx)=pvalnewIdx=(idx+delta).coerceIn(0,arr.length()-1)if(newIdx==idx)returnpathvalitems=mutableListOf<Any?>()for(iin0untilarr.length())items.add(arr.get(i))valitem=items.removeAt(idx)items.add(newIdx,item)while(arr.length()>0)arr.remove(arr.length()-1)items.forEach{arr.put(it)}valparentPath=path.substringBeforeLast("/")return"$parentPath/$newIdx"}privatefunmoveInArray(arr:JSONArray,index:Int,delta:Int){if(index<0||index>=arr.length())returnvalnewIdx=(index+delta).coerceIn(0,arr.length()-1)if(newIdx==index)returnvaltmp=mutableListOf<Any?>()for(iin0untilarr.length())tmp.add(arr.get(i))valit=tmp.removeAt(index)tmp.add(newIdx,it)while(arr.length()>0)arr.remove(arr.length()-1)tmp.forEach{arr.put(it)}}/*----Blueprints----*/privatefunnewSectionHeader()=JSONObject("""{"type":"SectionHeader","title":"Nuovasezione"}""".trimIndent())privatefunnewButtonRow()=JSONObject("""{"type":"ButtonRow","align":"center","buttons":[{"label":"Start","style":"primary","icon":"play_arrow","size":"md","tint":"default","shape":"rounded","corner":20,"pressEffect":"scale","actionId":"start_run"},{"label":"Pausa","style":"tonal","icon":"pause","size":"md","tint":"default","shape":"rounded","corner":20,"actionId":"pause_run"},{"label":"Stop","style":"outlined","icon":"stop","size":"md","tint":"error","shape":"rounded","corner":20,"actionId":"stop_run","confirm":true}]}""".trimIndent())privatefunnewSpacer()=JSONObject("""{"type":"Spacer","height":8}""".trimIndent())privatefunnewDividerV()=JSONObject("""{"type":"DividerV","thickness":1,"height":24}""".trimIndent())privatefunnewCard()=JSONObject("""{"type":"Card","variant":"elevated","clickActionId":"nav:run","blocks":[{"type":"SectionHeader","title":"Cardesempio","style":"titleSmall","align":"start"},{"type":"Divider"}]}""".trimIndent())privatefunnewFab()=JSONObject("""{"type":"Fab","icon":"play_arrow","label":"Start","variant":"extended","actionId":"start_run"}""".trimIndent())privatefunnewIconButton(menuId:String="more_menu")=JSONObject("""{"type":"IconButton","icon":"more_vert","openMenuId":"$menuId"}""".trimIndent())privatefunnewMenu(menuId:String="more_menu")=JSONObject("""{"type":"Menu","id":"$menuId","items":[{"icon":"tune","label":"LayoutLab","actionId":"open_layout_lab"},{"icon":"palette","label":"ThemeLab","actionId":"open_theme_lab"},{"icon":"settings","label":"Impostazioni","actionId":"nav:settings"}]}""".trimIndent())@ComposableprivatefunExposedDropdown(value:String,label:String,options:List<String>,onSelect:(String)->Unit){varexpandedbyremember{mutableStateOf(false)}ExposedDropdownMenuBox(expanded=expanded,onExpandedChange={expanded=!expanded}){OutlinedTextField(value=value,onValueChange={},readOnly=true,label={Text(label,style=MaterialTheme.typography.bodyMedium,color=LocalContentColor.current)},trailingIcon={ExposedDropdownMenuDefaults.TrailingIcon(expanded=expanded)},modifier=Modifier.menuAnchor())ExposedDropdownMenu(expanded=expanded,onDismissRequest={expanded=false}){options.forEach{opt->DropdownMenuItem(text={Text(opt)},onClick={onSelect(opt);expanded=false})}}}}privatefunduplicate(root:JSONObject,path:String){valp=getParentAndIndex(root,path)?:returnval(arr,idx)=pvalclone=JSONObject(arr.getJSONObject(idx).toString())valtmp=mutableListOf<Any?>()for(iin0untilarr.length()){tmp.add(arr.get(i))if(i==idx)tmp.add(clone)}while(arr.length()>0)arr.remove(arr.length()-1)tmp.forEach{arr.put(it)}}privatefunremove(root:JSONObject,path:String){valp=getParentAndIndex(root,path)?:returnval(arr,idx)=pvaltmp=mutableListOf<Any?>()for(iin0untilarr.length())if(i!=idx)tmp.add(arr.get(i))while(arr.length()>0)arr.remove(arr.length()-1)tmp.forEach{arr.put(it)}}privatefunremoveAt(arr:JSONArray,index:Int){if(index<0||index>=arr.length())returnvaltmp=mutableListOf<Any?>()for(iin0untilarr.length())if(i!=index)tmp.add(arr.get(i))while(arr.length()>0)arr.remove(arr.length()-1)tmp.forEach{arr.put(it)}}@Composable@Composable@ComposableprivatefunapplyTextStyleOverrides(node:JSONObject,base:TextStyle):TextStyle{varst=basevalsize=node.optDouble("textSizeSp",Double.NaN)if(!size.isNaN())st=st.copy(fontSize=size.sp)valweightKey=node.optString("fontWeight","")valweight=when(weightKey){"w300"->FontWeight.Light"w400"->FontWeight.Normal"w500"->FontWeight.Medium"w600"->FontWeight.SemiBold"w700"->FontWeight.Boldelse->null}if(weight!=null)st=st.copy(fontWeight=weight)valfamilyKey=node.optString("fontFamily","")valfamily=when(familyKey){"serif"->FontFamily.Serif"monospace"->FontFamily.Monospace"cursive"->FontFamily.Cursiveelse->null}if(family!=null)st=st.copy(fontFamily=family)returnst}privatevalNAMED_COLORS=linkedMapOf("Red"to0xFFE53935,"Pink"to0xFFD81B60,"Purple"to0xFF8E24AA,"DeepPurple"to0xFF5E35B1,"Indigo"to0xFF3949AB,"Blue"to0xFF1E88E5,"LightBlue"to0xFF039BE5,"Cyan"to0xFF00ACC1,"Teal"to0xFF00897B,"Green"to0xFF43A047,"LightGreen"to0xFF7CB342,"Lime"to0xFFC0CA33,"Yellow"to0xFFFDD835,"Amber"to0xFFFFB300,"Orange"to0xFFFB8C00,"DeepOrange"to0xFFF4511E,"Brown"to0xFF6D4C41,"BlueGrey"to0xFF546E7A)@ComposableprivatefunNamedColorPicker(currentHexOrEmpty:String,label:String,onPickHex:(String)->Unit){varexpandedbyremember{mutableStateOf(false)}valdisplay=if(currentHexOrEmpty.isBlank())"(default)"elsecurrentHexOrEmptyExposedDropdownMenuBox(expanded=expanded,onExpandedChange={expanded=!expanded}){OutlinedTextField(value=display,onValueChange={},readOnly=true,label={Text(label,style=MaterialTheme.typography.bodyMedium,color=LocalContentColor.current)},trailingIcon={ExposedDropdownMenuDefaults.TrailingIcon(expanded)},modifier=Modifier.menuAnchor())ExposedDropdownMenu(expanded=expanded,onDismissRequest={expanded=false}){NAMED_COLORS.forEach{(name,argb)->valc=Color(argb)DropdownMenuItem(leadingIcon={Box(Modifier.size(16.dp).background(c,RoundedCornerShape(3.dp)))},text={Text(name)},onClick={valhex="#%06X".format(0xFFFFFFandargb.toInt())onPickHex(hex);expanded=false})}DropdownMenuItem(text={Text("(default)")},onClick={onPickHex("");expanded=false})}}}/*----Readabilityhelper----*/privatefunbestOnColor(bg:Color):Color{vall=0.2126f*bg.red+0.7152f*bg.green+0.0722f*bg.bluereturnif(l<0.5f)Color.WhiteelseColor.Black}@ComposableprivatefunListInspector(layout:JSONObject,path:String,onApply:()->Unit,onCancel:()->Unit,onLive:()->Unit){varopenbyremember{mutableStateOf(true)}valblock=(jsonAtPath(layout,path)asJSONObject)valbackup=remember{JSONObject(block.toString())}funcloseApply(){open=false;onApply()}funcloseCancel(){replaceAtPath(layout,path,backup);open=false;onCancel()}ModalBottomSheet(onDismissRequest={closeCancel()},containerColor=MaterialTheme.colorScheme.surface.copy(alpha=0.20f),scrimColor=Color.Black.copy(alpha=0.32f)){valtextSize=remember{mutableStateOf(block.optDouble("textSizeSp",Double.NaN).let{if(it.isNaN())""elseit.toString()})}varfontFamilybyremember{mutableStateOf(block.optString("fontFamily",""))}varfontWeightbyremember{mutableStateOf(block.optString("fontWeight",""))}vartextColorbyremember{mutableStateOf(block.optString("textColor",""))}Column(Modifier.fillMaxWidth().verticalScroll(rememberScrollState()).padding(16.dp),verticalArrangement=Arrangement.spacedBy(12.dp)){Text("List-Proprietàtesto",style=MaterialTheme.typography.titleMedium)StepperField("textSize(sp)",textSize,1.0){v->if(v<=0.0)block.remove("textSizeSp")elseblock.put("textSizeSp",v);onLive()}ExposedDropdown(value=if(fontFamily.isBlank())"(default)"elsefontFamily,label="fontFamily",options=listOf("(default)","sans","serif","monospace","cursive")){sel->valv=if(sel=="(default)")""elseselfontFamily=vif(v.isBlank())block.remove("fontFamily")elseblock.put("fontFamily",v)onLive()}ExposedDropdown(value=if(fontWeight.isBlank())"(default)"elsefontWeight,label="fontWeight",options=listOf("(default)","w300","w400","w500","w600","w700")){sel->valv=if(sel=="(default)")""elseselfontWeight=vif(v.isBlank())block.remove("fontWeight")elseblock.put("fontWeight",v)onLive()}NamedColorPicker(currentHexOrEmpty=textColor,label="textColor",onPickHex={hex->textColor=hexif(hex.isBlank())block.remove("textColor")elseblock.put("textColor",hex)onLive()})Row{Spacer(Modifier.weight(1f))TextButton(onClick={closeCancel()}){Text("Annulla")}Button(onClick={closeApply()}){Text("OK")}}}}}@ComposableprivatefunChipRowInspector(layout:JSONObject,path:String,onApply:()->Unit,onCancel:()->Unit,onLive:()->Unit){varopenbyremember{mutableStateOf(true)}valblock=(jsonAtPath(layout,path)asJSONObject)valbackup=remember{JSONObject(block.toString())}funcloseApply(){open=false;onApply()}funcloseCancel(){replaceAtPath(layout,path,backup);open=false;onCancel()}ModalBottomSheet(onDismissRequest={closeCancel()},containerColor=MaterialTheme.colorScheme.surface.copy(alpha=0.20f),scrimColor=Color.Black.copy(alpha=0.32f)){valtextSize=remember{mutableStateOf(block.optDouble("textSizeSp",Double.NaN).let{if(it.isNaN())""elseit.toString()})}varfontFamilybyremember{mutableStateOf(block.optString("fontFamily",""))}varfontWeightbyremember{mutableStateOf(block.optString("fontWeight",""))}vartextColorbyremember{mutableStateOf(block.optString("textColor",""))}Column(Modifier.fillMaxWidth().verticalScroll(rememberScrollState()).padding(16.dp),verticalArrangement=Arrangement.spacedBy(12.dp)){Text("ChipRow-Proprietàtesto",style=MaterialTheme.typography.titleMedium)StepperField("textSize(sp)",textSize,1.0){v->if(v<=0.0)block.remove("textSizeSp")elseblock.put("textSizeSp",v);onLive()}ExposedDropdown(value=if(fontFamily.isBlank())"(default)"elsefontFamily,label="fontFamily",options=listOf("(default)","sans","serif","monospace","cursive")){sel->valv=if(sel=="(default)")""elseselfontFamily=vif(v.isBlank())block.remove("fontFamily")elseblock.put("fontFamily",v)onLive()}ExposedDropdown(value=if(fontWeight.isBlank())"(default)"elsefontWeight,label="fontWeight",options=listOf("(default)","w300","w400","w500","w600","w700")){sel->valv=if(sel=="(default)")""elseselfontWeight=vif(v.isBlank())block.remove("fontWeight")elseblock.put("fontWeight",v)onLive()}NamedColorPicker(currentHexOrEmpty=textColor,label="textColor",onPickHex={hex->textColor=hexif(hex.isBlank())block.remove("textColor")elseblock.put("textColor",hex)onLive()})Row{Spacer(Modifier.weight(1f))TextButton(onClick={closeCancel()}){Text("Annulla")}Button(onClick={closeApply()}){Text("OK")}}}}}